#!/bin/sh -euf

CRUSTY_API=`dirname $0`
CRUSTY_API=`cd ${CRUSTY_API}; pwd`
CRUSTY_CMD=`basename $0`
CRUSTY_BIN=`readlink $0 | xargs dirname`
CRUSTY_BIN=`cd ${CRUSTY_API}; cd ${CRUSTY_BIN}; pwd`
PATH=${CRUSTY_BIN}:${PATH}

. :bomb
. :val
. :array
. :math
. :string
. :http
. :json
. :specs
. :param
. :line
. :req
. :util
. :hooks
. :version
. :columns
. :positions
. :filter
. :delimit
. :session
. :auth
. :response
. :common $*

shift

. ^cmdline

hooks_pre ${CRUSTY_CMD} $*

version
columns
positions
filter
delimit

echo 0

line
echo 0.6
req

echo 1
http_payload
. ^cookie
echo 2
. ^session

#echo LINE: ${__line}
#echo PAYLOAD: ${__payload}
#echo URL: ${__url}
echo ${__url} ${__payload}

echo 3
set -x
> ${CRUSTY_HTTPCODE} curl                      \
    ${CRUSTY_COOKIES}                          \
    ${CRUSTY_CSRF}                             \
    -s                                         \
    -X ${CRUSTY_METHOD}                        \
    ${CRUSTY_DATA:-}                           \
    -o ${CRUSTY_RESPONSE}                      \
    -w %{http_code}                            \
    ${CRUSTY_HOST}:${CRUSTY_PORT}${__url}
set +x

echo 4
response_get

echo 5
http_code
hooks_post ${CRUSTY_CMD} $*
auth_checks

response
